This is the bug fix in development branch.
This code is from the "dev" branh.
